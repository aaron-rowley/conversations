<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VisQuanta — Conversation List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0b0b10; --card:#121218; --border:#1c1c25;
      --text:#e9e9f2; --muted:#a0a6b3; --accent:#ff7a00;
    }
    body{ background:var(--bg); color:var(--text) }
    .vq-card{ background:var(--card); border:1px solid var(--border) }
    .vq-input{ background:#151522; border:1px solid var(--border); color:var(--text) }
    .chip{ border:1px solid var(--border); background:#151522; color:var(--muted) }
    .badge{ font-size:10px; padding:2px 6px; border-radius:8px; display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); background:#252533; color:#cbd5e1 }
    .btn{ border:1px solid var(--border); background:#151522; color:var(--text); transition:transform .06s ease }
    .btn:active{ transform:translateY(1px) }
  </style>
</head>
<body class="min-h-screen">
  <main class="max-w-3xl mx-auto p-4">
    <section class="vq-card rounded-2xl overflow-hidden">
      <!-- Header -->
      <div class="px-4 py-3 flex items-center justify-between border-b border-[var(--border)]">
        <div class="font-semibold">Conversations</div>
        <button id="refresh" class="btn px-3 py-1.5 rounded-lg text-sm">Refresh</button>
      </div>

      <!-- Controls -->
      <div class="px-4 pt-3 pb-2 space-y-3">
        <!-- Tabs -->
        <div class="flex items-center gap-2 text-sm">
          <button data-tab="unread" class="tab active px-3 py-1.5 rounded-lg btn">Unread <span id="c-unread" class="ml-2 text-[10px] px-2 py-0.5 rounded-full" style="background:var(--accent); color:var(--bg)">0</span></button>
          <button data-tab="starred" class="tab px-3 py-1.5 rounded-lg btn">Starred</button>
          <button data-tab="all" class="tab px-3 py-1.5 rounded-lg btn">All</button>
          <div class="flex-1"></div>
          <!-- Channel filter -->
          <select id="channel" class="vq-input rounded-lg px-2 py-1.5 text-sm">
            <option value="">All Channels</option>
            <option value="sms">SMS</option>
            <option value="fb">FB/IG</option>
            <option value="ig">Instagram</option>
            <option value="email">Email</option>
          </select>
        </div>
        <!-- Search -->
        <input id="search" class="vq-input w-full rounded-lg px-3 py-2 text-sm" placeholder="Search name or phone…" />
      </div>

      <!-- Error -->
      <div id="error" class="px-4 text-sm text-red-400 hidden"></div>

      <!-- List -->
      <div id="list" class="divide-y divide-[var(--border)]"></div>

      <!-- Footer / Pagination -->
      <div class="px-4 py-3 flex items-center justify-between border-t border-[var(--border)]">
        <button id="prev" class="btn px-3 py-1.5 rounded-lg text-sm disabled:opacity-50">Prev</button>
        <div class="text-[11px] text-[var(--muted)]">Page <span id="page">1</span> / <span id="pages">1</span> • <span id="total">0</span> total</div>
        <button id="next" class="btn px-3 py-1.5 rounded-lg text-sm disabled:opacity-50">Next</button>
      </div>
    </section>
  </main>

<script>
(function(){
  // ---- Config via URL params ----
  const p = new URLSearchParams(location.search);
  const CFG = {
    listUrl: p.get("listUrl"),               // required (your n8n webhook)
    locationId: p.get("locationId") || "",   // required
    authHeader: p.get("authHeader") || "Authorization",
    authToken: p.get("authToken") || "",
    pageSize: +(p.get("pageSize") || 10),
  };

  // ---- DOM ----
  const listEl   = document.getElementById("list");
  const errEl    = document.getElementById("error");
  const pageEl   = document.getElementById("page");
  const pagesEl  = document.getElementById("pages");
  const totalEl  = document.getElementById("total");
  const searchEl = document.getElementById("search");
  const chanEl   = document.getElementById("channel");
  const prevEl   = document.getElementById("prev");
  const nextEl   = document.getElementById("next");
  const refreshEl= document.getElementById("refresh");
  const tabEls   = Array.from(document.querySelectorAll(".tab"));
  const cUnread  = document.getElementById("c-unread");

  // ---- State ----
  let tab = "unread";
  let page = 1;
  let totalPages = 1;
  let total = 0;
  let q = "";
  let channel = "";
  let loading = false;

  // ---- Helpers ----
  function headers(){
    const h = {"Content-Type":"application/json"};
    if (CFG.authToken) h[CFG.authHeader] = CFG.authToken;
    return h;
  }
  function postJSON(url, body){
    return fetch(url, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({ locationId: CFG.locationId, ...body })
    }).then(r => { if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); });
  }
  const timeAgo = (iso) => {
    if (!iso) return "";
    const t = Date.parse(iso), diff = Math.max(0, Date.now()-t);
    const m = Math.floor(diff/60000), h = Math.floor(m/60), d = Math.floor(h/24);
    if (m < 1) return "now";
    if (m < 60) return `${m}m`;
    if (h < 24) return `${h}h`;
    return `${d}d`;
  };
  const esc = (s) => String(s||"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));

  function renderItems(items){
    listEl.innerHTML = "";
    items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "px-4 py-3 flex items-start gap-3 hover:bg-[#161621] transition";

      const initials = (it.initials || (it.name||"VQ").split(" ").slice(0,2).map(s=>s[0]?.toUpperCase()).join("")) || "VQ";
      const avatar = `<div class="h-8 w-8 rounded-xl flex items-center justify-center text-xs font-semibold" style="background:#202030; color:var(--text)">${esc(initials)}</div>`;

      const chip = it.channel ? `<span class="badge">${it.channel}</span>` : "";

      row.innerHTML = `
        ${avatar}
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between gap-3">
            <div class="font-medium truncate">${esc(it.name || "Conversation")}</div>
            <div class="text-[10px] text-[var(--muted)] whitespace-nowrap">${esc(it.lastMessageAgo || timeAgo(it.lastMessageAt))}</div>
          </div>
          <div class="flex items-center gap-2 mt-1">
            ${chip}
            <div class="text-sm text-[var(--muted)] truncate">${esc(it.previewShort || it.preview || "")}</div>
          </div>
        </div>
        ${it.unreadCount ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full" style="background:var(--accent); color:var(--bg)">${it.unreadCount}</span>` : ""}
      `;
      listEl.appendChild(row);
    });
  }

  // ---- Fetch & wire ----
  function load(pageArg){
    if (loading) return;
    loading = true;
    errEl.classList.add("hidden");
    postJSON(CFG.listUrl, {
      tab, page: pageArg, pageSize: CFG.pageSize,
      q, channel
    }).then(data=>{
      page        = data.page || pageArg;
      totalPages  = Math.max(1, data.totalPages || Math.ceil((data.total||0) / (data.perPage||CFG.pageSize)));
      total       = data.total || 0;

      // counts (for the tab badge)
      const unreadCount = (data.countsByChannel ? Object.values(data.countsByChannel).reduce((a,b)=>a+b,0) : data.items?.length) || 0;
      cUnread.textContent = unreadCount;

      renderItems(data.items || []);
      pageEl.textContent  = String(page);
      pagesEl.textContent = String(totalPages);
      totalEl.textContent = String(total);
      prevEl.disabled = page <= 1;
      nextEl.disabled = page >= totalPages;
    }).catch(err=>{
      errEl.textContent = err.message || "Failed to load";
      errEl.classList.remove("hidden");
    }).finally(()=> loading = false);
  }

  // ---- Events ----
  tabEls.forEach(el=>{
    el.addEventListener("click", ()=>{
      tabEls.forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      tab = el.dataset.tab;
      page = 1;
      load(page);
    });
  });

  let tSearch;
  searchEl.addEventListener("input", e=>{
    clearTimeout(tSearch);
    tSearch = setTimeout(()=>{
      q = (e.target.value || "").trim();
      page = 1;
      load(page);
    }, 200);
  });

  chanEl.addEventListener("change", e=>{
    channel = e.target.value;
    page = 1;
    load(page);
  });

  document.getElementById("prev").onclick = ()=> { if(page>1) load(--page); };
  document.getElementById("next").onclick = ()=> { if(page<totalPages) load(++page); };
  refreshEl.onclick = ()=> load(page);

  // ---- Boot ----
  load(1);
})();
</script>
</body>
</html>
