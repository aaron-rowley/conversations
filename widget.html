<!-- [WIDGET_HTML_START] -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VisQuanta – Conversations</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --vq-primary: #5E6AD2;
      --vq-primaryText: #ffffff;
      --vq-incoming: #E9ECEF;
      --vq-incomingText: #111827;
    }
    .bubble-out { background: var(--vq-primary); color: var(--vq-primaryText); border-top-right-radius:.4rem; }
    .bubble-in { background: var(--vq-incoming); color: var(--vq-incomingText); border-top-left-radius:.4rem; }
    .shadow-soft { box-shadow: 0 4px 14px rgba(0,0,0,.06); }
    .truncate-2 { overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;}
  </style>
</head>
<body class="bg-white">
  <div id="app" class="p-4 max-w-7xl mx-auto">
    <div class="grid grid-cols-12 gap-4">
      <!-- Left: list -->
      <div class="col-span-12 md:col-span-4 lg:col-span-3 border rounded-2xl overflow-hidden shadow-soft">
        <div class="px-4 py-3 flex items-center justify-between border-b">
          <div class="font-semibold flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 6.75c0 8.284 6.716 15 15 15h1.5a2.25 2.25 0 002.25-2.25v-.495a1.125 1.125 0 00-.852-1.09l-4.423-1.106a1.125 1.125 0 00-1.09.285l-.97.97a12.04 12.04 0 01-6.313-6.313l.97-.97a1.125 1.125 0 00.285-1.09L6.585 2.85A1.125 1.125 0 005.495 2H5A2.25 2.25 0 002.75 4.25v2.5z"/></svg>
            Conversations
          </div>
          <button id="btn-refresh" class="text-sm px-2 py-1 rounded-md border hover:bg-gray-50">Refresh</button>
        </div>
        <div class="p-3">
          <input id="search" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Search…" />
        </div>
        <div id="list-error" class="hidden px-4 pb-2 text-sm text-red-600"></div>
        <div id="list" class="max-h-[70vh] overflow-auto divide-y"></div>
        <div class="p-3 border-t flex items-center justify-between">
          <button id="prev" class="text-sm px-3 py-1.5 rounded-md border disabled:opacity-50">Prev</button>
          <div class="text-xs text-gray-500"><span id="page">1</span>/<span id="pages">1</span></div>
          <button id="next" class="text-sm px-3 py-1.5 rounded-md border disabled:opacity-50">Next</button>
        </div>
      </div>

      <!-- Right: thread -->
      <div class="col-span-12 md:col-span-8 lg:col-span-9 border rounded-2xl overflow-hidden shadow-soft">
        <div class="px-4 py-3 border-b">
          <div id="thread-title" class="font-semibold truncate">Open a conversation</div>
        </div>
        <div id="thread-error" class="hidden px-4 pt-3 text-sm text-red-600"></div>
        <div id="thread" class="h-[60vh] overflow-auto p-4 space-y-2 bg-white"></div>
        <div class="p-3 border-t">
          <div class="border rounded-xl p-2">
            <textarea id="draft" rows="3" class="w-full resize-none border-0 focus:outline-none text-sm" placeholder="Type a message… (Enter to send, Shift+Enter for newline)"></textarea>
            <div class="mt-2 flex items-center justify-between">
              <div class="text-xs text-gray-500">Press Enter to send</div>
              <button id="send" class="px-3 py-1.5 text-sm rounded-lg bg-[var(--vq-primary)] text-white disabled:opacity-60">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- Query params ---
  const p = new URLSearchParams(location.search);
  const CFG = {
    listUrl: p.get("listUrl"),
    threadUrl: p.get("threadUrl"),
    sendUrl: p.get("sendUrl"),
    locationId: p.get("locationId"),
    authHeader: p.get("authHeader") || "Authorization",
    authToken: p.get("authToken") || "",
    pageSize: +(p.get("pageSize") || 20)
  };

  // --- Elements ---
  const listEl = document.getElementById("list");
  const listErr = document.getElementById("list-error");
  const threadEl = document.getElementById("thread");
  const threadErr = document.getElementById("thread-error");
  const titleEl = document.getElementById("thread-title");
  const searchEl = document.getElementById("search");
  const btnPrev = document.getElementById("prev");
  const btnNext = document.getElementById("next");
  const pageEl = document.getElementById("page");
  const pagesEl = document.getElementById("pages");
  const btnRefresh = document.getElementById("btn-refresh");
  const draftEl = document.getElementById("draft");
  const sendEl = document.getElementById("send");

  // --- State ---
  let page = 1, totalPages = 1;
  let items = [];
  let activeId = null;
  const meId = "me"; // map to your agent id in your webhook response

  // --- Utils ---
  function timeAgo(iso){
    const d = new Date(iso), diff = Date.now()-d.getTime();
    const s = Math.floor(diff/1000); if(s<60) return s+"s";
    const m = Math.floor(s/60); if(m<60) return m+"m";
    const h = Math.floor(m/60); if(h<24) return h+"h";
    const days = Math.floor(h/24); if(days<7) return days+"d";
    return d.toLocaleDateString();
  }
  function postJSON(url, body){
    return fetch(url, {
      method:"POST",
      headers: Object.assign({"Content-Type":"application/json"}, CFG.authToken ? {[CFG.authHeader]: CFG.authToken} : {}),
      body: JSON.stringify(Object.assign({ locationId: CFG.locationId }, body))
    }).then(r => { if(!r.ok) throw new Error("HTTP "+r.status+" on "+url); return r.json(); });
  }

  // --- List ---
  function renderList(){
    listEl.innerHTML = "";
    items.forEach(it => {
      const li = document.createElement("button");
      li.className = "w-full text-left px-4 py-3 hover:bg-gray-50 transition flex gap-3 "+(activeId===it.id?"bg-gray-50":"");
      li.onclick = () => fetchThread(it.id);
      li.innerHTML = `
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between gap-3">
            <div class="font-medium truncate">${escapeHtml(it.name||"Conversation")}</div>
            <div class="text-xs text-gray-500 whitespace-nowrap">${timeAgo(it.updatedAt)}</div>
          </div>
          <div class="text-sm text-gray-500 truncate">${escapeHtml(it.lastLine||"")}</div>
        </div>
        ${it.unreadCount?`<span class="ml-2 text-xs bg-[var(--vq-primary)] text-white px-2 py-0.5 rounded-full">${it.unreadCount}</span>`:""}
      `;
      listEl.appendChild(li);
    });
    pageEl.textContent = String(page);
    pagesEl.textContent = String(totalPages);
    btnPrev.disabled = page<=1;
    btnNext.disabled = page>=totalPages;
  }

  function fetchList(nextPage){
    listErr.classList.add("hidden");
    postJSON(CFG.listUrl, { page: nextPage, pageSize: CFG.pageSize })
      .then(data => {
        page = data.page || nextPage;
        totalPages = data.totalPages || 1;
        items = data.items || [];
        renderList();
      })
      .catch(e => {
        listErr.textContent = e.message || "Failed to load conversations";
        listErr.classList.remove("hidden");
      });
  }

  // --- Thread ---
  function renderThread(data){
    threadEl.innerHTML = "";
    const messages = data.messages || [];
    const other = (data.participants||[]).find(p => p.id !== meId);
    titleEl.textContent = other?.name || "Conversation";

    messages.sort((a,b)=>new Date(a.sentAt)-new Date(b.sentAt));
    messages.forEach(m=>{
      const mine = m.authorId === meId;
      const wrap = document.createElement("div");
      wrap.className = "flex "+(mine?"justify-end":"justify-start");
      const bubble = document.createElement("div");
      bubble.className = "max-w-[80%] px-4 py-2 rounded-2xl text-sm shadow-soft "+(mine?"bubble-out":"bubble-in");
      bubble.innerHTML = `
        <div class="whitespace-pre-wrap break-words">${escapeHtml(m.text||"")}</div>
        <div class="mt-1 text-[10px] opacity-70 ${mine?"text-white":"text-gray-500"}">${new Date(m.sentAt).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</div>
      `;
      wrap.appendChild(bubble);
      threadEl.appendChild(wrap);
    });
    threadEl.scrollTop = threadEl.scrollHeight;
  }

  function fetchThread(id){
    activeId = id;
    threadErr.classList.add("hidden");
    postJSON(CFG.threadUrl, { conversationId: id })
      .then(data => renderThread(data))
      .catch(e => {
        threadErr.textContent = e.message || "Failed to load conversation";
        threadErr.classList.remove("hidden");
      });
  }

  // --- Send ---
  function sendMessage(){
    const text = (draftEl.value||"").trim();
    if(!activeId || !text) return;
    // optimistic render
    renderThread({
      participants: [{id:"other", name:titleEl.textContent}],
      messages: [...documentOptimisticMessages(), { id:"optimistic-"+Date.now(), authorId: meId, text, sentAt:new Date().toISOString() }]
    });
    draftEl.value = "";
    sendEl.disabled = true;
    postJSON(CFG.sendUrl, { conversationId: activeId, text })
      .then(()=> fetchThread(activeId))
      .catch(()=> fetchThread(activeId))
      .finally(()=> sendEl.disabled = false);
  }

  function documentOptimisticMessages(){
    // best-effort: we don't parse DOM back; just return empty and rely on refetch after send
    return [];
  }

  // --- Events ---
  btnPrev.onclick = () => { if(page>1) { page--; fetchList(page); } };
  btnNext.onclick = () => { if(page<totalPages) { page++; fetchList(page); } };
  btnRefresh.onclick = () => fetchList(page);
  searchEl.addEventListener("input", e=>{
    const q = (e.target.value||"").toLowerCase();
    const filtered = items.filter(i=> (i.name||"").toLowerCase().includes(q) || (i.lastLine||"").toLowerCase().includes(q));
    const backup = items; items = filtered; renderList(); items = backup;
  });
  draftEl.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });
  sendEl.onclick = sendMessage;

  // --- Helpers ---
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s]));
  }

  // Initial load
  fetchList(1);
})();
</script>
</body>
</html>
<!-- [WIDGET_HTML_END] -->
